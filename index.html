<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÈáéÁç£„ÇØ„É™„ÉÉ„Ç´„ÉºÔºöÂÆåÂÖ®Âæ©Ê¥ªÁâà (v17)</title>
    <style>
        /* --- „Éô„Éº„ÇπË®≠ÂÆö --- */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none; -webkit-user-select: none;
            touch-action: manipulation;
        }

        /* --- „Ç®„Éï„Çß„ÇØ„Éà„É¨„Ç§„É§„Éº --- */
        #effect-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5; overflow: hidden;
        }

        /* --- „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà --- */
        #game-container { display: flex; flex: 1; height: 100%; z-index: 10; }
        
        #main-panel {
            flex: 1;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative;
            background: radial-gradient(circle, #333 0%, #000 100%);
            border-right: 2px solid #444;
        }

        #shop-panel {
            flex: 1; max-width: 450px; background-color: #222;
            display: flex; flex-direction: column; border-left: 2px solid #000;
            z-index: 20;
        }

        @media (max-width: 768px) {
            #game-container { flex-direction: column; }
            #main-panel { flex: 0.8; border-right: none; border-bottom: 2px solid #444; }
            #shop-panel { flex: 1.2; max-width: 100%; }
            .click-area { width: 180px !important; height: 180px !important; }
        }

        /* --- „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†± --- */
        .stats-bar {
            width: 100%; padding: 8px; background: rgba(0,0,0,0.8);
            display: flex; justify-content: space-around;
            position: absolute; top: 0; z-index: 50;
            font-size: 0.9em; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .stat-group { text-align: center; }
        .stat-label { font-size: 0.7em; color: #aaa; display: block; }
        .stat-val { font-weight: bold; font-size: 1.1em; text-shadow: 1px 1px 0 #000; }
        .val-gold { color: #ffcc00; } .val-dia { color: #00ffff; } .val-mult { color: #ff5555; }

        /* --- „ÇØ„É™„ÉÉ„ÇØ„Ç®„É™„Ç¢ & „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ --- */
        .click-area {
            width: 260px; height: 260px;
            border-radius: 50%;
            border: 8px solid #ffcc00;
            box-shadow: 0 0 50px rgba(255, 204, 0, 0.2);
            cursor: pointer; position: relative; z-index: 30;
            background: #fff; overflow: hidden;
            transition: transform 0.05s;
        }
        .click-area:active { transform: scale(0.95); }
        
        .click-area img {
            width: 100%; height: 100%; object-fit: cover;
            pointer-events: none;
        }

        /* ÂõûËª¢„Ç¢„Éã„É° */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spin-slow { animation: spin 20s linear infinite; }
        .spin-fast { animation: spin 2s linear infinite; }

        /* ÊåØÂãï„Ç¢„Éã„É° */
        @keyframes shake {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-5px, 5px) rotate(-5deg); }
            50% { transform: translate(5px, -5px) rotate(5deg); }
            75% { transform: translate(-5px, -5px) rotate(-5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .shaking { animation: shake 0.2s ease-in-out; }

        /* --- „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ --- */
        .pop-particle {
            position: absolute; pointer-events: none;
            width: 40px; height: 40px; border-radius: 50%; z-index: 100;
            transition: all 0.8s ease-out; opacity: 1;
        }
        .falling-yaju {
            position: absolute; top: -100px; pointer-events: none;
            opacity: 0.6; z-index: 1;
            animation: fall linear forwards;
        }
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(110vh) rotate(360deg); }
        }
        .floating-text {
            position: absolute; pointer-events: none; font-weight: bold; font-size: 1.8em;
            color: #fff; text-shadow: 2px 2px 0 #000;
            animation: floatUp 0.8s ease-out forwards; z-index: 200;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.5); } }

        /* --- „Éú„Éº„Éä„Çπ„É¢„Éº„Éâ --- */
        body.bonus-mode #main-panel { animation: rainbow-bg 0.5s infinite alternate; }
        @keyframes rainbow-bg {
            0% { background: #500; } 50% { background: #050; } 100% { background: #005; }
        }
        #bonus-banner {
            display: none; position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            z-index: 100; pointer-events: none; text-align: center;
        }
        #bonus-text {
            font-size: 4em; font-weight: 900; color: #ff0000;
            text-shadow: 0 0 10px #fff, 0 0 20px #ff00de;
            animation: pulse 0.2s infinite alternate;
        }
        @keyframes pulse { to { transform: scale(1.1); } }

        /* --- „Ç∑„Éß„ÉÉ„Éó --- */
        .shop-header {
            padding: 15px; background: #333; color: #fff; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555;
        }
        .shop-content { flex: 1; overflow-y: auto; padding: 10px; }
        .shop-item {
            background: #2a2a2a; border: 1px solid #444; border-radius: 8px;
            padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: all 0.1s;
        }
        .shop-item:active { transform: scale(0.98); background: #444; }
        .shop-item.disabled { opacity: 0.5; pointer-events: none; background: #111; }
        
        .item-info { display: flex; flex-direction: column; text-align: left; }
        .item-name { font-weight: bold; font-size: 1em; }
        .item-power { font-size: 0.8em; color: #88ff88; }
        .item-cost { font-size: 0.9em; font-weight: bold; color: #ffcc00; }
        .item-count-box {
            background: #111; padding: 5px 10px; border-radius: 5px;
            font-size: 1.2em; font-weight: bold; color: #fff; border: 1px solid #555;
            min-width: 40px; text-align: center;
        }

        /* --- „Éú„Çø„É≥Áæ§ --- */
        .menu-buttons {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; z-index: 40; pointer-events: auto;
        }
        .btn {
            background: #444; color: #fff; border: 1px solid #777;
            padding: 8px 12px; border-radius: 5px; cursor: pointer;
            font-size: 0.85em; font-weight: bold;
            box-shadow: 0 4px 0 #222; transition: transform 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #222; }
        .btn-gacha { background: #0055aa; border-color: #0088ff; }
        .btn-battle { background: #aa0000; border-color: #ff4444; }
        .btn-rebirth { background: #5500aa; border-color: #8844ff; }
        .btn-ach { background: #aa8800; border-color: #ffcc00; color: #000; }

        /* --- „É¢„Éº„ÉÄ„É´ & „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal.open { display: flex; }
        .modal-box {
            background: #222; border: 2px solid #555; padding: 20px; border-radius: 10px;
            width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; color: #fff;
        }
        .list-item {
            background: #333; margin-bottom: 5px; padding: 8px; border-radius: 5px;
            display: flex; align-items: center; gap: 10px; border: 1px solid #444;
        }
        .list-item.locked { opacity: 0.5; filter: grayscale(1); }
        .list-icon { font-size: 1.5em; }
        
        .notification {
            position: absolute; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 100, 255, 0.9); color: white;
            padding: 10px 20px; border-radius: 20px; border: 2px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 3000; transition: top 0.5s;
            display: flex; align-items: center; gap: 10px; pointer-events: none;
        }
        .notification.show { top: 20px; }

        /* „Éú„ÇπUI */
        #boss-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50, 0, 0, 0.8); z-index: 60; flex-direction: column;
            justify-content: center; align-items: center; pointer-events: none;
        }
        #boss-overlay.active { display: flex; }
        .boss-hp-bar { width: 80%; height: 20px; background: #333; border: 2px solid #fff; margin: 10px 0; position: relative; }
        .boss-hp-fill { height: 100%; background: #ff0000; width: 100%; transition: width 0.1s; }

        /* „Çπ„Çø„Éº„ÉàÁîªÈù¢ */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="start-screen" onclick="startGame()">
        <h1 style="color:#ffcc00;">ÈáéÁç£„ÇØ„É™„ÉÉ„Ç´„Éº</h1>
        <p style="color:#fff; animation:pulse 1s infinite;">TAP TO START</p>
    </div>

    <div id="notification" class="notification">
        <div style="font-size:2em;">üèÜ</div>
        <div>
            <div style="font-weight:bold; color:#ffcc00;" id="notify-title">ÂÆüÁ∏æËß£Èô§ÔºÅ</div>
            <div style="font-size:0.8em;" id="notify-desc">Ë©≥Á¥∞</div>
        </div>
    </div>

    <audio id="bgm" src="bgm.mp3" loop></audio>

    <div id="effect-layer"></div>

    <div id="game-container">
        <div id="main-panel">
            <div class="stats-bar">
                <div class="stat-group"><span class="stat-label">ÊâÄÊåÅÈáë</span><span id="score-display" class="stat-val val-gold">0</span></div>
                <div class="stat-group"><span class="stat-label">ÁßíÈñì</span><span id="sps-display" class="stat-val">0</span></div>
                <div class="stat-group"><span class="stat-label">„ÉÄ„Ç§„É§</span><span id="diamond-display" class="stat-val val-dia">0</span></div>
                <div class="stat-group"><span class="stat-label">ÂÄçÁéá</span><span id="mult-display" class="stat-val val-mult">x1.0</span></div>
            </div>

            <div id="bonus-banner">
                <div id="bonus-text">FEVER!!</div>
                <div id="bonus-timer" style="color:#fff; font-weight:bold; font-size:1.5em;">10.0s</div>
            </div>

            <div id="boss-overlay">
                <h2 style="color:#ff5555; text-shadow:2px 2px 0 #000; margin:0;">BOSS BATTLE</h2>
                <div style="font-size:1.5em; font-weight:bold; color:#fff;" id="boss-name">ÈáéÁç£„ÅÆÂΩ±</div>
                <div class="boss-hp-bar"><div id="boss-hp-fill" class="boss-hp-fill"></div></div>
                <div id="boss-hp-text" style="color:#fff; font-weight:bold;">100 / 100</div>
                <div id="boss-timer" style="color:#ffaaaa; font-size:1.2em; margin-top:5px;">30.00</div>
            </div>

            <div class="click-area" onclick="handleClick(event)">
                <img src="ÈáéÁç£.png" id="main-icon" class="spin-slow">
            </div>

            <div class="menu-buttons">
                <button class="btn" id="mute-btn" onclick="toggleMute()">üéµ Èü≥ON</button>
                <button class="btn btn-ach" onclick="showAchievements()">üèÜ ÂÆüÁ∏æ</button>
                <button class="btn btn-gacha" id="gacha-btn" onclick="pullGacha()">üì¶ „Ç¨„ÉÅ„É£</button>
                <button class="btn btn-battle" onclick="toggleBattle()">‚öîÔ∏è „ÉÄ„É≥„Ç∏„Éß„É≥</button>
                <button class="btn btn-rebirth" onclick="doRebirth()">üîÑ Ëª¢Áîü</button>
                <button class="btn" onclick="resetGame()">üóëÔ∏è</button>
            </div>
        </div>

        <div id="shop-panel">
            <div class="shop-header">
                <span>„Ç∑„Éß„ÉÉ„Éó</span>
                <span style="font-size:0.8em; color:#aaa;">ÁîüÁî£ÂäõÂº∑Âåñ</span>
            </div>
            <div id="shop-list" class="shop-content"></div>
        </div>
    </div>

    <div id="common-modal" class="modal">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-top:0; border-bottom:1px solid #555; padding-bottom:10px;">„Çø„Ç§„Éà„É´</h3>
            <div id="modal-body"></div>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn" onclick="document.getElementById('common-modal').classList.remove('open')">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <script>
        /* --- 1. „Ç≤„Éº„É†„Éá„Éº„ÇøË®≠ÂÆö --- */
        const SAVE_KEY = 'yaju_clicker_v17';
        let game = {
            score: 0, diamonds: 0, rank: 0, gachaMult: 1.0, bossKills: 0,
            floor: 1, maxFloor: 1, itemCounts: [], achievements: [], gachaCount: 0
        };

        const items = [
            { name: "„Äå„Åì‚Üë„Åì‚Üì„Äç", type: "click", baseCost: 15, power: 1 },
            { name: "Êüî„Çâ„Åã„ÅÑÊûï", type: "auto", baseCost: 50, power: 1 },
            { name: "ÁéãÈÅì„ÇíÂæÄ„Åè", type: "click", baseCost: 150, power: 3 },
            { name: "„Ç¢„Ç§„Çπ„ÉÜ„Ç£„Éº", type: "auto", baseCost: 500, power: 5 },
            { name: "„Éå„ÉÉÔºÅ", type: "click", baseCost: 1200, power: 10 },
            { name: "Êó•ÁÑº„Åë„Çµ„É≠„É≥", type: "auto", baseCost: 3000, power: 25 },
            { name: "Â±ã‰∏ä", type: "auto", baseCost: 10000, power: 80 },
            { name: "„Ç§„Ç≠„Çπ„ÇÆ„Ç§„ÇØ„Ç§„ÇØ", type: "click", baseCost: 50000, power: 100 },
            { name: "ÈªíÂ°ó„Çä„ÅÆÈ´òÁ¥öËªä", type: "auto", baseCost: 114514, power: 810 },
            { name: "ÈáéÁç£„ÅÆÁúºÂÖâ", type: "auto", baseCost: 8101919, power: 5000 },
            { name: "ÁÑº„ÅÑ„Å¶„Åã„Å™„ÅÑÔºü", type: "click", baseCost: 50000000, power: 20000 },
            { name: "ËÅñÂú∞Â∑°Á§º", type: "auto", baseCost: 1000000000, power: 100000 },
            { name: "Ê∑´Â§¢„Åè„Çì", type: "auto", baseCost: 100000000000, power: 5000000 },
            { name: "ÁúüÂ§è„ÅÆÂ§ú„ÅÆÊ∑´Â§¢", type: "auto", baseCost: 8101145141919, power: 810191919 },
            { name: "„Äå„Éå„ÉÉ„Äç„ÅÆÊ¶ÇÂøµ", type: "auto", baseCost: 500000000000000, power: 10000000000 },
            { name: "ÂÖ®Áü•ÂÖ®ËÉΩ", type: "auto", baseCost: 810000000000000000, power: 10000000000000 }
        ];

        const achievementList = [
            { id: "click_1", name: "ÂàùÊäïÁ®ø", desc: "Âàù„ÇÅ„Å¶„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã", condition: () => game.score > 0 },
            { id: "score_114514", name: "„ÅÑ„ÅÑ„ÇàÔºÅÊù•„ÅÑ„ÇàÔºÅ", desc: "114,514 YJ Ë≤Ø„ÇÅ„Çã", condition: () => game.score >= 114514 },
            { id: "rebirth_1", name: "Áîü„ÅçËøî„ÇåÁîü„ÅçËøî„Çå", desc: "Âàù„ÇÅ„Å¶Ëª¢Áîü„Åô„Çã", condition: () => game.rank >= 1 },
            { id: "floor_10", name: "„ÉÄ„É≥„Ç∏„Éß„É≥Êé¢Á¥¢ËÄÖ", desc: "10ÈöéÂà∞ÈÅî", condition: () => game.maxFloor >= 10 },
            { id: "boss_10", name: "ÈáéÁç£„Éè„É≥„Çø„Éº", desc: "„Éú„Çπ10‰ΩìË®é‰ºê", condition: () => game.bossKills >= 10 },
            { id: "item_last", name: "ÂÆåËµ∞„Åó„ÅüÊÑüÊÉ≥", desc: "ÊúÄÂæå„ÅÆ„Ç¢„Ç§„ÉÜ„É†Ë≥ºÂÖ•", condition: () => game.itemCounts[items.length-1] > 0 }
        ];

        while (game.itemCounts.length < items.length) game.itemCounts.push(0);

        let isBossBattle = false;
        let bossData = { max: 100, current: 100, time: 30 };
        let isMuted = false;
        let isGameStarted = false;
        
        let bonusTimer = 0;
        let nextBonusTimer = 60;
        let isBonusActive = false;

        /* --- 2. Ë®àÁÆóÈñ¢Êï∞ --- */
        function getGlobalMult() {
            let m = 1;
            m *= (1 + game.rank * 0.1); 
            m *= game.gachaMult;
            m *= (1 + game.bossKills * 0.02);
            m *= (1 + game.achievements.length * 0.05); // ÂÆüÁ∏æ„Éú„Éº„Éä„ÇπÂæ©Ê¥ª
            return m;
        }

        function getBaseStats() {
            let cp = 1; let ai = 0;
            items.forEach((item, index) => {
                let count = game.itemCounts[index] || 0;
                if (item.type === 'click') cp += item.power * count;
                else ai += item.power * count;
            });
            return { cp: cp, ai: ai };
        }

        function getRealStats() {
            let base = getBaseStats();
            let mult = getGlobalMult();
            return { click: base.cp * mult, auto: base.ai * mult };
        }

        function getItemCost(index) {
            let count = game.itemCounts[index] || 0;
            return Math.floor(items[index].baseCost * Math.pow(1.15, count));
        }

        /* --- 3. „Ç¢„ÇØ„Ç∑„Éß„É≥ --- */
        function startGame() {
            isGameStarted = true;
            document.getElementById('start-screen').style.display = 'none';
            if(!isMuted) document.getElementById('bgm').play().catch(()=>{});
        }

        function playSE(type) {
            if (isMuted || !isGameStarted) return;
            const audio = new Audio(type + '.mp3'); 
            audio.volume = 0.5;
            audio.play().catch(()=>{});
        }

        function handleClick(e) {
            playSE('tap');
            
            // „Ç¢„Ç§„Ç≥„É≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âæ©Ê¥ª
            const icon = document.getElementById('main-icon');
            const area = document.querySelector('.click-area');
            area.classList.remove('shaking');
            void area.offsetWidth; 
            area.classList.add('shaking');

            let stats = getRealStats();
            let power = stats.click;
            if (isBonusActive) power *= 5;

            if (isBossBattle) {
                bossData.current -= power;
                spawnText(e.clientX, e.clientY, `Damage ${formatNum(power)}`, '#ff5555');
                if (bossData.current <= 0) winBattle();
            } else {
                game.score += power;
                spawnText(e.clientX, e.clientY, `+${formatNum(power)}`, '#fff');
            }
            
            spawnParticles(e.clientX, e.clientY); // Á≤íÂ≠ê„Ç®„Éï„Çß„ÇØ„ÉàÂæ©Ê¥ª
            checkAchievements();
            updateUI();
        }

        function buyItem(index) {
            let cost = getItemCost(index);
            if (game.score >= cost) {
                playSE('buy');
                game.score -= cost;
                game.itemCounts[index]++;
                updateUI();
                saveGame();
            }
        }

        function toggleBattle() {
            if (isBossBattle) {
                isBossBattle = false;
                document.getElementById('boss-overlay').classList.remove('active');
            } else {
                isBossBattle = true;
                bossData.max = 1000000 * Math.pow(1.3, game.floor - 1);
                bossData.current = bossData.max;
                bossData.time = 30;
                document.getElementById('boss-overlay').classList.add('active');
                document.getElementById('boss-name').innerText = `BOSS: ÈáéÁç£„ÅÆÂΩ± ${game.floor}F`;
            }
            updateUI();
        }

        function winBattle() {
            isBossBattle = false;
            document.getElementById('boss-overlay').classList.remove('active');
            game.bossKills++;
            game.floor++;
            if (game.floor > game.maxFloor) game.maxFloor = game.floor;
            let reward = bossData.max * 0.1;
            game.score += reward;
            alert(`Ë®é‰ºêÊàêÂäüÔºÅ\nÂ†±ÈÖ¨: ${formatNum(reward)} YJ`);
            saveGame(); updateUI();
        }

        function pullGacha() {
            if (game.diamonds < 10) return alert("„ÉÄ„Ç§„É§„ÅåË∂≥„Çä„Åæ„Åõ„Çì(10ÂÄã)");
            if(!confirm("10„ÉÄ„Ç§„É§„Åß„Ç¨„ÉÅ„É£„ÇíÂõû„Åó„Åæ„Åô„ÅãÔºü")) return;
            game.diamonds -= 10;
            game.gachaCount++;
            playSE('buy');
            
            let rand = Math.random();
            let boost = (rand < 0.05) ? 0.5 : (rand < 0.2) ? 0.2 : 0.05;
            let msg = (rand < 0.05) ? "„ÄêË∂ÖÊøÄ„É¨„Ç¢„Äë+50%" : (rand < 0.2) ? "„ÄêÂ§ßÂΩì„Åü„Çä„Äë+20%" : "„ÄêÂΩì„Åü„Çä„Äë+5%";
            game.gachaMult += boost;
            alert(msg); saveGame(); updateUI();
        }

        function doRebirth() {
            let req = 1000000 * Math.pow(10, game.rank);
            if (game.score < req) return alert(`ÂøÖË¶Å: ${formatNum(req)} YJ`);
            let dia = (game.rank + 1) * 10;
            if(confirm(`Ëª¢Áîü„Åó„Åæ„Åô„ÅãÔºü\n„É©„É≥„ÇØ+1, „ÉÄ„Ç§„É§+${dia}`)) {
                game.score = 0;
                game.itemCounts = game.itemCounts.map(() => 0);
                game.rank++; game.diamonds += dia; game.floor = 1;
                saveGame(); location.reload();
            }
        }

        /* --- 4. ÊºîÂá∫„ÉªUI --- */
        function formatNum(n) { return Math.floor(n).toLocaleString(); }

        function spawnText(x, y, text, color) {
            let el = document.createElement('div');
            el.className = 'floating-text'; el.innerText = text; el.style.color = color;
            el.style.left = (x + (Math.random()*40-20)) + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function spawnParticles(x, y) {
            for(let i=0; i<8; i++) {
                let p = document.createElement('img');
                p.src = 'ÈáéÁç£.png'; p.className = 'pop-particle';
                p.style.left = x + 'px'; p.style.top = y + 'px';
                let angle = Math.random() * Math.PI * 2;
                let speed = 50 + Math.random() * 100;
                let tx = Math.cos(angle) * speed;
                let ty = Math.sin(angle) * speed;
                document.body.appendChild(p);
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                p.animate([
                    { transform: `translate(0,0) scale(0.5)`, opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], { duration: 800, fill: 'forwards' });
                setTimeout(() => p.remove(), 800);
            }
        }

        function spawnFallingYaju() {
            if(isBossBattle) return;
            let el = document.createElement('img');
            el.src = 'ÈáéÁç£.png'; el.className = 'falling-yaju';
            el.style.left = Math.random() * 100 + 'vw';
            el.style.width = (30 + Math.random() * 50) + 'px';
            document.getElementById('effect-layer').appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function initUI() {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            items.forEach((item, i) => {
                let div = document.createElement('div');
                div.className = 'shop-item'; div.id = `shop-item-${i}`;
                div.onclick = () => buyItem(i);
                let typeColor = item.type === 'click' ? '#ffaa00' : '#00aaff';
                div.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">${item.name}</span>
                        <span class="item-power" style="color:${typeColor}">+${formatNum(item.power)}</span>
                        <span class="item-cost" id="cost-${i}">-</span>
                    </div>
                    <div class="item-count-box" id="count-${i}">0</div>
                `;
                list.appendChild(div);
            });
            updateUI();
        }

        function updateUI() {
            document.getElementById('score-display').innerText = formatNum(game.score);
            let stats = getRealStats();
            let finalSps = stats.auto * (isBonusActive ? 5 : 1);
            document.getElementById('sps-display').innerText = formatNum(finalSps);
            document.getElementById('diamond-display').innerText = formatNum(game.diamonds);
            document.getElementById('mult-display').innerText = "x" + getGlobalMult().toFixed(2);

            items.forEach((item, i) => {
                let cost = getItemCost(i);
                document.getElementById(`cost-${i}`).innerText = formatNum(cost) + " YJ";
                document.getElementById(`count-${i}`).innerText = game.itemCounts[i];
                let el = document.getElementById(`shop-item-${i}`);
                if (game.score >= cost) el.classList.remove('disabled');
                else el.classList.add('disabled');
            });

            if (isBossBattle) {
                let pct = (bossData.current / bossData.max) * 100;
                document.getElementById('boss-hp-fill').style.width = Math.max(0, pct) + "%";
                document.getElementById('boss-hp-text').innerText = `${formatNum(Math.max(0,bossData.current))} / ${formatNum(bossData.max)}`;
                document.getElementById('boss-timer').innerText = Math.max(0, bossData.time).toFixed(1);
            }
        }

        /* --- ÂÆüÁ∏æ --- */
        function checkAchievements() {
            achievementList.forEach(ach => {
                if(!game.achievements.includes(ach.id)) {
                    if(ach.condition()) {
                        game.achievements.push(ach.id);
                        showNotification(ach.name);
                        updateUI(); saveGame();
                    }
                }
            });
        }

        function showNotification(name) {
            const el = document.getElementById('notification');
            document.getElementById('notify-desc').innerText = name;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
            playSE('buy');
        }

        function showAchievements() {
            const body = document.getElementById('modal-body');
            document.getElementById('modal-title').innerText = "ÂÆüÁ∏æ„É™„Çπ„Éà";
            body.innerHTML = "";
            achievementList.forEach(ach => {
                let unlocked = game.achievements.includes(ach.id);
                body.innerHTML += `
                    <div class="list-item ${unlocked ? '' : 'locked'}">
                        <div class="list-icon">üèÜ</div>
                        <div>
                            <div style="font-weight:bold; color:${unlocked ? '#ffcc00' : '#aaa'}">${ach.name}</div>
                            <div style="font-size:0.8em; color:#aaa;">${ach.desc}</div>
                        </div>
                    </div>`;
            });
            document.getElementById('common-modal').classList.add('open');
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('mute-btn');
            if(isMuted) {
                document.getElementById('bgm').pause();
                btn.innerText = "üîá Èü≥OFF";
                btn.style.background = "#800";
            } else {
                if(isGameStarted) document.getElementById('bgm').play().catch(()=>{});
                btn.innerText = "üîä Èü≥ON";
                btn.style.background = "#444";
            }
        }

        /* --- 5. „É´„Éº„Éó --- */
        setInterval(() => {
            let stats = getRealStats();
            
            // „Éú„Éº„Éä„ÇπÂá¶ÁêÜ
            if(isBonusActive) {
                bonusTimer -= 0.1;
                document.getElementById('bonus-timer').innerText = bonusTimer.toFixed(1)+"s";
                if(bonusTimer <= 0) {
                    isBonusActive = false;
                    document.body.classList.remove('bonus-mode');
                    document.getElementById('bonus-banner').style.display = 'none';
                    document.getElementById('main-icon').classList.remove('spin-fast');
                    document.getElementById('main-icon').classList.add('spin-slow');
                    updateUI();
                }
            } else {
                nextBonusTimer -= 0.1;
                if(nextBonusTimer <= 0) {
                    isBonusActive = true; bonusTimer = 10; nextBonusTimer = 60;
                    document.body.classList.add('bonus-mode');
                    document.getElementById('bonus-banner').style.display = 'block';
                    document.getElementById('main-icon').classList.remove('spin-slow');
                    document.getElementById('main-icon').classList.add('spin-fast');
                    updateUI();
                }
            }

            // Ëá™ÂãïÂèéÂÖ•
            if (stats.auto > 0) {
                let income = (stats.auto * (isBonusActive ? 5 : 1)) / 10;
                if (isBossBattle) {
                    bossData.current -= income;
                    if(bossData.current <= 0) winBattle();
                } else {
                    game.score += income;
                }
            }

            // „Éú„Çπ„Çø„Ç§„Éû„Éº
            if (isBossBattle) {
                bossData.time -= 0.1;
                if(bossData.time <= 0) {
                    isBossBattle = false;
                    document.getElementById('boss-overlay').classList.remove('active');
                    alert("ÊôÇÈñìÂàá„ÇåÔºÅ");
                }
            }

            // ËÉåÊôØÊºîÂá∫
            if(!isBossBattle && Math.random() < 0.05) spawnFallingYaju();

            updateUI();
        }, 100);

        setInterval(() => saveGame(), 5000);

        function saveGame() { localStorage.setItem(SAVE_KEY, JSON.stringify(game)); }
        
        function loadGame() {
            let data = localStorage.getItem(SAVE_KEY);
            if (!data) { // Êóß„Éá„Éº„ÇøÂºï„ÅçÁ∂ô„Åé
                const oldKeys = ['yaju_clicker_save_v16','yaju_clicker_save_v15','yaju_clicker_save_v14','yaju_clicker_save_v13'];
                for (let k of oldKeys) { let d = localStorage.getItem(k); if (d) { data = d; break; } }
            }
            if (data) {
                try {
                    let p = JSON.parse(data);
                    if(p.score) game.score = p.score;
                    if(p.rank) game.rank = p.rank;
                    if(p.diamonds) game.diamonds = p.diamonds;
                    if(p.gachaMult) game.gachaMult = p.gachaMult;
                    if(p.bossKills) game.bossKills = p.bossKills;
                    if(p.achievements) game.achievements = p.achievements;
                    if(p.itemCounts) {
                        p.itemCounts.forEach((c, i) => { if(game.itemCounts[i] !== undefined) game.itemCounts[i] = c; });
                    }
                } catch(e) {}
            }
        }
        function resetGame() {
            if(confirm("ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) { localStorage.clear(); location.reload(); }
        }

        // ÂàùÊúüÂåñ
        loadGame();
        initUI();
    </script>
</body>
</html>
