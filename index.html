<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‡ç£ã‚¯ãƒªãƒƒã‚«ãƒ¼ï¼šãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ç‰ˆ (v16)</title>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #eee;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (PC/ã‚¹ãƒãƒ›è‡ªå‹•åˆ‡æ›¿) --- */
        #game-container {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        /* å·¦å´ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼‰ */
        #main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: radial-gradient(circle, #333 0%, #111 100%);
            border-right: 2px solid #444;
        }

        /* å³å´ï¼ˆã‚·ãƒ§ãƒƒãƒ—ã‚¨ãƒªã‚¢ï¼‰ */
        #shop-panel {
            flex: 1;
            max-width: 450px;
            background-color: #222;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #000;
        }

        /* ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (ç¸¦ä¸¦ã³) */
        @media (max-width: 768px) {
            #game-container { flex-direction: column; }
            #main-panel { flex: 0.8; border-right: none; border-bottom: 2px solid #444; }
            #shop-panel { flex: 1.2; max-width: 100%; border-left: none; }
            .click-area { width: 180px !important; height: 180px !important; }
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± --- */
        .stats-bar {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: space-around;
            position: absolute;
            top: 0;
            z-index: 100;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .stat-group { text-align: center; }
        .stat-label { font-size: 0.7em; color: #aaa; display: block; }
        .stat-val { font-weight: bold; font-size: 1.1em; color: #fff; }
        .val-gold { color: #ffcc00; }
        .val-dia { color: #00ffff; }
        .val-mult { color: #ff5555; }

        /* --- ã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒªã‚¢ --- */
        .click-area {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: 8px solid #ffcc00;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.3);
            cursor: pointer;
            transition: transform 0.05s;
            position: relative;
            z-index: 10;
            background: #fff;
            overflow: hidden;
        }
        .click-area:active { transform: scale(0.95); }
        .click-area img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spin-slow { animation: spin 20s linear infinite; }
        .spin-fast { animation: spin 2s linear infinite; }
        
        @keyframes flash { 0% { filter: brightness(1); } 50% { filter: brightness(2); } 100% { filter: brightness(1); } }
        .flash-anim { animation: flash 0.1s; }

        /* --- ã‚·ãƒ§ãƒƒãƒ—ãƒªã‚¹ãƒˆ --- */
        .shop-header {
            padding: 15px;
            background: #333;
            color: #fff;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
        }
        .shop-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .shop-item {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.1s;
        }
        .shop-item:hover { background: #353535; }
        .shop-item:active { background: #444; transform: translateY(1px); }
        .shop-item.disabled { opacity: 0.5; pointer-events: none; background: #111; }

        .item-info { display: flex; flex-direction: column; text-align: left; }
        .item-name { font-weight: bold; font-size: 1em; color: #fff; }
        .item-power { font-size: 0.8em; color: #88ff88; }
        .item-cost { font-size: 0.9em; font-weight: bold; color: #ffcc00; }
        
        .item-count-box {
            background: #111;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            border: 1px solid #555;
            min-width: 40px;
            text-align: center;
        }

        /* --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ç¾¤ --- */
        .menu-buttons {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 20;
            width: 90%;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn {
            background: #444; color: #fff; border: 1px solid #666;
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            font-size: 0.9em; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .btn:active { transform: translateY(2px); }
        .btn-gacha { background: linear-gradient(45deg, #003366, #0066cc); border-color: #0088ff; }
        .btn-battle { background: linear-gradient(45deg, #660000, #cc0000); border-color: #ff4444; }
        .btn-rebirth { background: linear-gradient(45deg, #330066, #6600cc); border-color: #8844ff; }

        /* --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ --- */
        .floating-text {
            position: absolute; pointer-events: none; font-weight: bold; font-size: 1.5em;
            color: #fff; text-shadow: 1px 1px 0 #000;
            animation: floatUp 0.8s ease-out forwards; z-index: 1000;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* ãƒœã‚¹UI */
        #boss-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50, 0, 0, 0.8); z-index: 50; flex-direction: column;
            justify-content: center; align-items: center; pointer-events: none;
        }
        #boss-overlay.active { display: flex; }
        .boss-hp-bar {
            width: 80%; height: 20px; background: #333; border: 2px solid #fff; margin-top: 10px;
            position: relative; overflow: hidden;
        }
        .boss-hp-fill { height: 100%; background: #ff0000; width: 100%; transition: width 0.1s; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal.open { display: flex; }
        .modal-box {
            background: #222; border: 2px solid #555; padding: 20px; border-radius: 10px;
            width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; color: #fff;
        }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding: 5px 0; }
    </style>
</head>
<body>

    <audio id="bgm" src="bgm.mp3" loop></audio>
    <audio id="se-tap" src="tap.mp3"></audio>
    <audio id="se-buy" src="buy.mp3"></audio>

    <div id="game-container">
        
        <div id="main-panel">
            <div class="stats-bar">
                <div class="stat-group">
                    <span class="stat-label">æ‰€æŒé‡‘ (YJ)</span>
                    <span id="score-display" class="stat-val val-gold">0</span>
                </div>
                <div class="stat-group">
                    <span class="stat-label">ç§’é–“ (YJ/s)</span>
                    <span id="sps-display" class="stat-val">0</span>
                </div>
                <div class="stat-group">
                    <span class="stat-label">ãƒ€ã‚¤ãƒ¤</span>
                    <span id="diamond-display" class="stat-val val-dia">0</span>
                </div>
                <div class="stat-group">
                    <span class="stat-label">åˆè¨ˆå€ç‡</span>
                    <span id="mult-display" class="stat-val val-mult">x1.0</span>
                </div>
            </div>

            <div id="boss-overlay">
                <h2 style="color:#ff5555; text-shadow:2px 2px #000;">BOSS BATTLE</h2>
                <div style="font-size:1.5em; font-weight:bold;" id="boss-timer">30.00</div>
                <div class="boss-hp-bar"><div id="boss-hp-fill" class="boss-hp-fill"></div></div>
                <div id="boss-hp-text">100 / 100</div>
            </div>

            <div class="click-area" onclick="handleClick(event)">
                <img src="é‡ç£.png" id="main-icon" class="spin-slow">
            </div>

            <div class="menu-buttons">
                <button class="btn" onclick="toggleMute()">ğŸµ éŸ³åˆ‡æ›¿</button>
                <button class="btn" onclick="showStats()">ğŸ“Š è©³ç´°</button>
                <button class="btn btn-gacha" onclick="pullGacha()">ğŸ“¦ ã‚¬ãƒãƒ£</button>
                <button class="btn btn-battle" onclick="toggleBattle()">âš”ï¸ è¨ä¼</button>
                <button class="btn btn-rebirth" onclick="doRebirth()">ğŸ”„ è»¢ç”Ÿ</button>
            </div>
        </div>

        <div id="shop-panel">
            <div class="shop-header">
                <span>ã‚·ãƒ§ãƒƒãƒ—</span>
                <span style="font-size:0.8em; color:#aaa;">ç”Ÿç”£åŠ›å¼·åŒ–</span>
            </div>
            <div id="shop-list" class="shop-content">
                </div>
        </div>
    </div>

    <div id="common-modal" class="modal">
        <div class="modal-box">
            <h3 id="modal-title">ã‚¿ã‚¤ãƒˆãƒ«</h3>
            <div id="modal-body">å†…å®¹</div>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn" onclick="document.getElementById('common-modal').classList.remove('open')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        /* --- 1. ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å®šç¾© --- */
        const SAVE_KEY = 'yaju_clicker_v16';
        let game = {
            score: 0,
            diamonds: 0,
            rank: 0,
            gachaMult: 1.0,
            bossKills: 0,
            floor: 1,
            maxFloor: 1,
            itemCounts: [], // é…åˆ—ã§å€‹æ•°ç®¡ç†
            artifacts: []
        };

        // ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ (ä¸å¤‰)
        const items = [
            { name: "ã€Œã“â†‘ã“â†“ã€", type: "click", baseCost: 15, power: 1 },
            { name: "æŸ”ã‚‰ã‹ã„æ•", type: "auto", baseCost: 50, power: 1 },
            { name: "ç‹é“ã‚’å¾€ã", type: "click", baseCost: 150, power: 3 },
            { name: "ã‚¢ã‚¤ã‚¹ãƒ†ã‚£ãƒ¼", type: "auto", baseCost: 500, power: 5 },
            { name: "ãƒŒãƒƒï¼", type: "click", baseCost: 1200, power: 10 },
            { name: "æ—¥ç„¼ã‘ã‚µãƒ­ãƒ³", type: "auto", baseCost: 3000, power: 25 },
            { name: "å±‹ä¸Š", type: "auto", baseCost: 10000, power: 80 },
            { name: "ã‚¤ã‚­ã‚¹ã‚®ã‚¤ã‚¯ã‚¤ã‚¯", type: "click", baseCost: 50000, power: 100 },
            { name: "é»’å¡—ã‚Šã®é«˜ç´šè»Š", type: "auto", baseCost: 114514, power: 810 },
            { name: "é‡ç£ã®çœ¼å…‰", type: "auto", baseCost: 8101919, power: 5000 },
            { name: "ç„¼ã„ã¦ã‹ãªã„ï¼Ÿ", type: "click", baseCost: 50000000, power: 20000 },
            { name: "è–åœ°å·¡ç¤¼", type: "auto", baseCost: 1000000000, power: 100000 },
            { name: "æ·«å¤¢ãã‚“", type: "auto", baseCost: 100000000000, power: 5000000 },
            { name: "çœŸå¤ã®å¤œã®æ·«å¤¢", type: "auto", baseCost: 8101145141919, power: 810191919 },
            { name: "ã€ŒãƒŒãƒƒã€ã®æ¦‚å¿µ", type: "auto", baseCost: 500000000000000, power: 10000000000 },
            { name: "å…¨çŸ¥å…¨èƒ½", type: "auto", baseCost: 810000000000000000, power: 10000000000000 }
        ];

        // ã‚¢ã‚¤ãƒ†ãƒ å€‹æ•°é…åˆ—ã®åˆæœŸåŒ–
        while (game.itemCounts.length < items.length) {
            game.itemCounts.push(0);
        }

        // çŠ¶æ…‹å¤‰æ•°
        let isBossBattle = false;
        let bossData = { max: 100, current: 100, time: 30 };
        let isMuted = false;

        /* --- 2. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (Heart) --- */
        
        // åˆè¨ˆå€ç‡
        function getGlobalMult() {
            let m = 1;
            m *= (1 + game.rank * 0.1); // ãƒ©ãƒ³ã‚¯ãƒœãƒ¼ãƒŠã‚¹
            m *= game.gachaMult;        // ã‚¬ãƒãƒ£
            m *= (1 + game.bossKills * 0.02); // é­‚ãƒœãƒ¼ãƒŠã‚¹
            return m;
        }

        // åŸºç¤èƒ½åŠ› (ã‚¢ã‚¤ãƒ†ãƒ å€‹æ•° x ãƒ‘ãƒ¯ãƒ¼)
        function getBaseStats() {
            let cp = 1;
            let ai = 0;
            items.forEach((item, index) => {
                let count = game.itemCounts[index] || 0;
                if (item.type === 'click') cp += item.power * count;
                else ai += item.power * count;
            });
            return { cp: cp, ai: ai };
        }

        // å®Ÿéš›ã®èƒ½åŠ› (åŸºç¤ x å€ç‡)
        function getRealStats() {
            let base = getBaseStats();
            let mult = getGlobalMult();
            return { 
                click: base.cp * mult, 
                auto: base.ai * mult 
            };
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ä¾¡æ ¼è¨ˆç®— (1.15å€ãšã¤å¢—åŠ )
        function getItemCost(index) {
            let count = game.itemCounts[index] || 0;
            return Math.floor(items[index].baseCost * Math.pow(1.15, count));
        }

        /* --- 3. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ --- */

        function handleClick(e) {
            playSE('se-tap');
            const icon = document.getElementById('main-icon');
            icon.classList.remove('flash-anim');
            void icon.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼
            icon.classList.add('flash-anim');

            let stats = getRealStats();
            let dmg = stats.click;

            // ãƒœã‚¹æˆ¦å‡¦ç†
            if (isBossBattle) {
                bossData.current -= dmg;
                spawnText(e.clientX, e.clientY, `-${formatNum(dmg)}`, '#ff5555');
                if (bossData.current <= 0) winBattle();
            } else {
                game.score += dmg;
                spawnText(e.clientX, e.clientY, `+${formatNum(dmg)}`, '#fff');
            }
            updateUI();
        }

        function buyItem(index) {
            let cost = getItemCost(index);
            if (game.score >= cost) {
                playSE('se-buy');
                game.score -= cost;
                game.itemCounts[index]++;
                updateUI();
                saveGame();
            }
        }

        function pullGacha() {
            let cost = 10;
            if (game.diamonds < cost) return alert("ãƒ€ã‚¤ãƒ¤ãŒè¶³ã‚Šã¾ã›ã‚“ (10å€‹å¿…è¦)");
            
            game.diamonds -= cost;
            playSE('se-buy');
            
            let rand = Math.random();
            let boost = 0;
            let msg = "";
            
            if (rand < 0.05) { boost = 0.5; msg = "ã€è¶…æ¿€ãƒ¬ã‚¢ã€‘å€ç‡+50%ï¼"; }
            else if (rand < 0.20) { boost = 0.2; msg = "ã€å¤§å½“ãŸã‚Šã€‘å€ç‡+20%ï¼"; }
            else { boost = 0.05; msg = "ã€å½“ãŸã‚Šã€‘å€ç‡+5%"; }
            
            game.gachaMult += boost;
            alert(msg);
            saveGame();
            updateUI();
        }

        function toggleBattle() {
            if (isBossBattle) {
                // é€ƒã’ã‚‹
                isBossBattle = false;
                document.getElementById('boss-overlay').classList.remove('active');
            } else {
                // é–‹å§‹
                isBossBattle = true;
                bossData.max = 1000000 * Math.pow(1.3, game.floor - 1);
                bossData.current = bossData.max;
                bossData.time = 30;
                document.getElementById('boss-overlay').classList.add('active');
            }
            updateUI();
        }

        function winBattle() {
            isBossBattle = false;
            document.getElementById('boss-overlay').classList.remove('active');
            game.bossKills++;
            game.floor++;
            if (game.floor > game.maxFloor) game.maxFloor = game.floor;
            
            let reward = bossData.max * 0.1; // å ±é…¬
            game.score += reward;
            
            alert(`è¨ä¼æˆåŠŸï¼\nå ±é…¬: ${formatNum(reward)} YJ\næ¬¡ã®éšå±¤ã¸é€²ã¿ã¾ã™ã€‚`);
            saveGame();
            updateUI();
        }

        function doRebirth() {
            let req = 1000000 * Math.pow(10, game.rank);
            if (game.score < req) return alert(`è»¢ç”Ÿã«ã¯ ${formatNum(req)} YJ å¿…è¦ã§ã™`);
            
            let dia = (game.rank + 1) * 10;
            if(confirm(`è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ\nãƒ»ãƒ©ãƒ³ã‚¯ +1\nãƒ»ãƒ€ã‚¤ãƒ¤ +${dia}\nãƒ»ãŠé‡‘ã¨ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚»ãƒƒãƒˆ`)) {
                game.score = 0;
                game.itemCounts = game.itemCounts.map(() => 0); // å…¨ãƒªã‚»ãƒƒãƒˆ
                game.rank++;
                game.diamonds += dia;
                game.floor = 1;
                saveGame();
                location.reload();
            }
        }

        /* --- 4. ç”»é¢æ›´æ–° (View) --- */

        // æ•°å­—æ•´å½¢ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)
        function formatNum(n) {
            return Math.floor(n).toLocaleString();
        }

        // åˆæœŸåŒ–: ã‚·ãƒ§ãƒƒãƒ—ãƒªã‚¹ãƒˆç”Ÿæˆ
        function initUI() {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            items.forEach((item, i) => {
                let div = document.createElement('div');
                div.className = 'shop-item';
                div.id = `shop-item-${i}`;
                div.onclick = () => buyItem(i);
                
                // ã‚¿ã‚¤ãƒ—åˆ¥è‰²
                let typeColor = item.type === 'click' ? '#ffaa00' : '#00aaff';
                let typeText = item.type === 'click' ? 'ã‚¿ãƒƒãƒ—åŠ›' : 'ç§’é–“åå…¥';

                div.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">${item.name}</span>
                        <span class="item-power" style="color:${typeColor}">
                            ${typeText} +${formatNum(item.power)}
                        </span>
                        <span class="item-cost" id="cost-${i}">Loading...</span>
                    </div>
                    <div class="item-count-box" id="count-${i}">0</div>
                `;
                list.appendChild(div);
            });
            updateUI();
        }

        // å…¨ä½“æ›´æ–°
        function updateUI() {
            let stats = getRealStats();

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            document.getElementById('score-display').innerText = formatNum(game.score);
            document.getElementById('sps-display').innerText = formatNum(stats.auto);
            document.getElementById('diamond-display').innerText = formatNum(game.diamonds);
            document.getElementById('mult-display').innerText = "x" + getGlobalMult().toFixed(2);

            // ã‚·ãƒ§ãƒƒãƒ—
            items.forEach((item, i) => {
                let cost = getItemCost(i);
                let elItem = document.getElementById(`shop-item-${i}`);
                
                // ä¾¡æ ¼ã¨å€‹æ•°æ›´æ–°
                document.getElementById(`cost-${i}`).innerText = formatNum(cost) + " YJ";
                document.getElementById(`count-${i}`).innerText = game.itemCounts[i];

                // è²·ãˆã‚‹ã‹åˆ¤å®š
                if (game.score >= cost) elItem.classList.remove('disabled');
                else elItem.classList.add('disabled');
            });

            // ãƒœã‚¹æˆ¦
            if (isBossBattle) {
                let pct = (bossData.current / bossData.max) * 100;
                document.getElementById('boss-hp-fill').style.width = Math.max(0, pct) + "%";
                document.getElementById('boss-hp-text').innerText = `${formatNum(bossData.current)} / ${formatNum(bossData.max)}`;
                document.getElementById('boss-timer').innerText = bossData.time.toFixed(1);
            }
        }

        function spawnText(x, y, text, color) {
            let el = document.createElement('div');
            el.className = 'floating-text';
            el.innerText = text;
            el.style.color = color;
            el.style.left = (x + (Math.random()*40-20)) + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function showStats() {
            const modal = document.getElementById('common-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            title.innerText = "è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹";
            let stats = getRealStats();
            let base = getBaseStats();
            
            body.innerHTML = `
                <div class="stat-row"><span>é‡ç£ãƒ©ãƒ³ã‚¯</span><span>${game.rank}</span></div>
                <div class="stat-row"><span>ã‚¬ãƒãƒ£å€ç‡</span><span>x${game.gachaMult.toFixed(2)}</span></div>
                <div class="stat-row"><span>é­‚ãƒœãƒ¼ãƒŠã‚¹</span><span>x${(1 + game.bossKills * 0.02).toFixed(2)}</span></div>
                <hr>
                <div class="stat-row"><span>åŸºç¤ã‚¿ãƒƒãƒ—åŠ›</span><span>${formatNum(base.cp)}</span></div>
                <div class="stat-row"><span>åŸºç¤ç§’é–“åå…¥</span><span>${formatNum(base.ai)}</span></div>
                <div class="stat-row" style="color:#ffcc00"><span>æœ€çµ‚å€ç‡</span><span>x${getGlobalMult().toFixed(2)}</span></div>
                <div class="stat-row"><span>ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³éšå±¤</span><span>${game.floor}F</span></div>
            `;
            modal.classList.add('open');
        }

        /* --- 5. ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ— & ã‚»ãƒ¼ãƒ– --- */

        // 0.1ç§’ã”ã¨ã®ãƒ«ãƒ¼ãƒ—
        setInterval(() => {
            let stats = getRealStats();
            
            // è‡ªå‹•åå…¥ (0.1ç§’åˆ†)
            if (stats.auto > 0) {
                let income = stats.auto / 10;
                
                if (isBossBattle) {
                    bossData.current -= income; // ãƒœã‚¹ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸
                    if (bossData.current <= 0) winBattle();
                } else {
                    game.score += income; // é€šå¸¸åå…¥
                }
            }

            // ãƒœã‚¹ã‚¿ã‚¤ãƒãƒ¼
            if (isBossBattle) {
                bossData.time -= 0.1;
                if (bossData.time <= 0) {
                    isBossBattle = false;
                    document.getElementById('boss-overlay').classList.remove('active');
                    alert("æ™‚é–“åˆ‡ã‚Œ... é€ƒã’å¸°ã‚Šã¾ã—ãŸ");
                }
            }

            updateUI();
        }, 100);

        // 5ç§’ã”ã¨ã«ã‚»ãƒ¼ãƒ–
        setInterval(() => saveGame(), 5000);

        function saveGame() {
            localStorage.setItem(SAVE_KEY, JSON.stringify(game));
        }

        function loadGame() {
            // v16ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
            let data = localStorage.getItem(SAVE_KEY);
            
            // ãªã‘ã‚Œã°éå»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¢ã—ã¦å¤‰æ›
            if (!data) {
                const oldKeys = ['yaju_clicker_save_v15','yaju_clicker_save_v14','yaju_clicker_save_v13'];
                for (let k of oldKeys) {
                    let oldData = localStorage.getItem(k);
                    if (oldData) {
                        console.log("éå»ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ã:", k);
                        data = oldData;
                        break;
                    }
                }
            }

            if (data) {
                try {
                    let parsed = JSON.parse(data);
                    // å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒãƒ¼ã‚¸
                    if (parsed.score) game.score = parsed.score;
                    if (parsed.rank) game.rank = parsed.rank;
                    if (parsed.diamonds) game.diamonds = parsed.diamonds;
                    if (parsed.itemCounts) {
                        parsed.itemCounts.forEach((c, i) => {
                            if (game.itemCounts[i] !== undefined) game.itemCounts[i] = c;
                        });
                    }
                    if (parsed.gachaMultiplier) game.gachaMult = parsed.gachaMultiplier; // å¤‰æ•°åå¤‰æ›´å¯¾å¿œ
                    if (parsed.gachaMult) game.gachaMult = parsed.gachaMult;
                    if (parsed.bossKills) game.bossKills = parsed.bossKills;
                    if (parsed.floor) game.floor = parsed.floor;
                    if (parsed.dungeonFloor) game.floor = parsed.dungeonFloor; // å¤‰æ•°åå¤‰æ›´å¯¾å¿œ
                } catch (e) {
                    console.error("Save load error", e);
                }
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            if(!isMuted) {
                document.getElementById('bgm').play().catch(()=>{});
            } else {
                document.getElementById('bgm').pause();
            }
        }
        function playSE(id) {
            if (!isMuted) {
                let se = document.getElementById(id);
                se.currentTime = 0;
                se.play().catch(()=>{});
            }
        }
        function resetGame() {
            if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.clear();
                location.reload();
            }
        }

        /* --- èµ·å‹• --- */
        loadGame();
        initUI();

    </script>
</body>
</html>
